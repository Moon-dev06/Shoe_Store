name: Refined Store CI/CD

on:
  push:
    branches: [ "main" ] # ทำงานทุกครั้งที่มีการ Push เข้าสาขา main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 1. Build & Push Frontend (ใช้ชื่อ Image ของคุณ)
      - name: Build and Push Frontend
        run: |
          docker build -t moondev06/shoe-frontend ./refined-app/frontend
          docker push moondev06/shoe-frontend:latest

      # 2. Build & Push Backend
      - name: Build and Push Backend
        run: |
          docker build -t moondev06/shoe-backend ./refined-app/backend
          docker push moondev06/shoe-backend:latest

  deploy-to-kubernetes:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # เชื่อมต่อกับ AWS โดยใช้ Secrets 3 ตัวที่เราเพิ่งตั้งค่าไป
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ap-southeast-2 # ตรวจสอบ Region ให้ตรงกับ Cluster ของคุณ

      # สั่งให้ GitHub รู้จักกับ Cluster ของเรา
      - name: Update Kubeconfig
        run: aws eks update-kubeconfig --name <ใส่-ชื่อ-Cluster-ของคุณ-ตรงนี้>

      # สั่ง Deploy ไฟล์ YAML ในโฟลเดอร์ k8s ขึ้น Cloud
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/backend-deploy.yaml
          kubectl apply -f k8s/frontend-deploy.yaml